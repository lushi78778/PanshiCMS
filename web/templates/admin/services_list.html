<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>PanshiCMS - 服务管理</title>
  <!-- 引入 layui 样式 -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/layui/2.8.0/css/layui.css" />
  <style>
    body { font-family: sans-serif; margin: 0; background-color: #f8f9fa; }
    .container { display: flex; min-height: 100vh; }
    .sidebar { width: 220px; background-color: #343a40; color: white; padding-top: 20px; flex-shrink: 0; }
    .sidebar h2 { text-align: center; margin-bottom: 30px; }
    .sidebar ul { list-style-type: none; padding: 0; margin: 0; }
    .sidebar ul li a { display: block; color: #adb5bd; padding: 15px 20px; text-decoration: none; }
    .sidebar ul li a:hover,
    .sidebar ul li a.active { background-color: #495057; color: white; }
    .main-content { flex-grow: 1; }
    .header { background-color: white; padding: 15px 30px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
    .header h1 { margin: 0; font-size: 24px; }
    .content { padding: 30px; }
    .pagination { margin-top: 20px; }
    .pagination button { padding: 8px 12px; margin-right: 5px; cursor: pointer; }
  </style>
</head>
<body>
<div class="container">
  <div class="sidebar">
    <h2>PanshiCMS</h2>
    <ul>
      <li><a href="/admin/dashboard">仪表盘</a></li>
      <li><a href="/admin/news">新闻管理</a></li>
      <li><a href="/admin/services" class="active">服务管理</a></li>
      <li><a href="/admin/cases">案例管理</a></li>
      <li><a href="/admin/banners">轮播图管理</a></li>
      <li><a href="/admin/settings">站点设置</a></li>
    </ul>
  </div>
  <div class="main-content">
    <div class="header">
      <h1>服务管理</h1>
      <a href="/admin/services/new" class="layui-btn">新增服务</a>
    </div>
    <div class="content">
      <table class="layui-table">
        <thead>
        <tr>
          <th>ID</th>
          <th>标题</th>
          <th>排序</th>
          <th>推荐</th>
          <th>操作</th>
        </tr>
        </thead>
        <tbody id="services-table-body">
        </tbody>
      </table>
      <div id="pagination-controls" class="pagination"></div>
    </div>
  </div>
</div>

<script>
  const token = localStorage.getItem('jwt_token');
  if (!token) {
    window.location.href = '/admin/login';
  }
  const tableBody = document.getElementById('services-table-body');
  const paginationControls = document.getElementById('pagination-controls');

  async function fetchServices(page = 1) {
    try {
      const response = await fetch(`/api/v1/services?page=${page}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (response.status === 401) {
        window.location.href = '/admin/login';
        return;
      }
      const result = await response.json();
      if (response.ok) {
        renderTable(result.data.list);
        renderPagination(result.data.total, result.data.page, result.data.pageSize);
      } else {
        alert(result.error || '获取数据失败');
      }
    } catch (error) {
      console.error(error);
      alert('网络错误');
    }
  }

  function renderTable(list) {
    tableBody.innerHTML = '';
    if (!list || list.length === 0) {
      tableBody.innerHTML = '<tr><td colspan="5" style="text-align:center;">暂无数据</td></tr>';
      return;
    }
    list.forEach(item => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${item.ID}</td>
        <td>${item.title}</td>
        <td>${item.sortOrder}</td>
        <td>${item.isRecommended ? '是' : '否'}</td>
        <td>
          <a href="/admin/services/edit/${item.ID}">编辑</a>
          <a href="#" onclick="deleteService(${item.ID})">删除</a>
        </td>
      `;
      tableBody.appendChild(row);
    });
  }

  function renderPagination(total, currentPage, pageSize) {
    paginationControls.innerHTML = '';
    const totalPages = Math.ceil(total / pageSize);
    for (let i = 1; i <= totalPages; i++) {
      const button = document.createElement('button');
      button.textContent = i;
      if (i === currentPage) {
        button.disabled = true;
      }
      button.onclick = () => fetchServices(i);
      paginationControls.appendChild(button);
    }
  }

  async function deleteService(id) {
    if (!confirm(`确定要删除ID为 ${id} 的服务吗？`)) {
      return;
    }
    try {
      const response = await fetch(`/api/v1/services/${id}`, {
        method: 'DELETE',
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const result = await response.json();
      if (response.ok) {
        alert('删除成功');
        fetchServices(1);
      } else {
        alert(result.error || '删除失败');
      }
    } catch (error) {
      alert('网络错误');
    }
  }

  document.addEventListener('DOMContentLoaded', () => {
    fetchServices(1);
  });
</script>
<script src="https://cdn.staticfile.org/layui/2.8.0/layui.js"></script>
</body>
</html>