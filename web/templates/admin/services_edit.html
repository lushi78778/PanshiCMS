<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>PanshiCMS - 编辑服务</title>
    <!-- 引入 layui 样式 -->
    <link rel="stylesheet" href="https://cdn.staticfile.org/layui/2.8.0/css/layui.css" />
    <!-- 引入 AiEditor 样式 -->
    <link rel="stylesheet" href="/static/aieditor/style.css" />
    <style>
        body { font-family: sans-serif; margin: 0; background-color: #f8f9fa; }
        .container { display: flex; min-height: 100vh; }
        .sidebar { width: 220px; background-color: #343a40; color: white; padding-top: 20px; flex-shrink: 0; }
        .sidebar h2 { text-align: center; margin-bottom: 30px; font-size: 20px; }
        .sidebar ul { list-style: none; padding: 0; margin: 0; }
        .sidebar ul li a { display: block; color: #adb5bd; padding: 15px 20px; text-decoration: none; }
        .sidebar ul li a:hover,
        .sidebar ul li a.active { background-color: #495057; color: white; }
        .main-content { flex-grow: 1; }
        .header { background-color: white; padding: 15px 30px; border-bottom: 1px solid #dee2e6; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { margin: 0; font-size: 24px; }
        .content { padding: 30px; }
        /* 隐藏 textarea，用于同步编辑器内容 */
        #content { display: none; }
        /* AiEditor 容器样式 */
        #aiEditor {
            margin-bottom: 20px;
            height: 550px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="sidebar">
        <h2>PanshiCMS</h2>
        <ul>
            <li><a href="/admin/dashboard">仪表盘</a></li>
            <li><a href="/admin/news">新闻管理</a></li>
            <li><a href="/admin/services" class="active">服务管理</a></li>
            <li><a href="/admin/cases">案例管理</a></li>
            <li><a href="/admin/banners">轮播图管理</a></li>
            <li><a href="/admin/settings">站点设置</a></li>
        </ul>
    </div>
    <div class="main-content">
        <div class="header">
            <h1 id="page-title">新建服务</h1>
            <a href="/admin/services" class="layui-btn layui-btn-primary">返回列表</a>
        </div>
        <div class="content">
            <form id="editForm" class="layui-form">
                <input type="hidden" id="serviceId" name="serviceId">

                <div class="layui-form-item">
                    <label class="layui-form-label" for="title">标题</label>
                    <div class="layui-input-block">
                        <input type="text" id="title" name="title" required lay-verify="required" placeholder="请输入服务名称" class="layui-input">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">封面图片</label>
                    <div class="layui-input-block">
                        <input type="file" id="coverImage" accept="image/*" class="layui-input">
                        <input type="hidden" id="coverImageUrl" name="coverImageUrl">
                        <div style="margin-top:10px;">
                            <img id="coverPreview" src="" alt="封面预览" style="max-width:200px; display:none;">
                        </div>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="summary">摘要</label>
                    <div class="layui-input-block">
                        <textarea id="summary" name="summary" class="layui-textarea" placeholder="请输入简短描述"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label">正文</label>
                    <div class="layui-input-block">
                        <!-- AiEditor 容器 -->
                        <div id="aiEditor"></div>
                        <!-- 隐藏 textarea 用于提交 HTML 内容 -->
                        <textarea id="content" name="content"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="isRecommended">推荐首页</label>
                    <div class="layui-input-block" style="padding-top:9px;">
                        <input type="checkbox" id="isRecommended" name="isRecommended" lay-skin="primary" title="标记为首页轮播图">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="sortOrder">排序</label>
                    <div class="layui-input-block">
                        <input type="number" id="sortOrder" name="sortOrder" class="layui-input" value="99">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="slug">URL别名</label>
                    <div class="layui-input-block">
                        <input type="text" id="slug" name="slug" required lay-verify="required" placeholder="slug，如服务别名" class="layui-input">
                    </div>
                </div>

                <hr>
                <h3 style="margin:20px 0 10px;">SEO 设置</h3>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="metaTitle">SEO 标题</label>
                    <div class="layui-input-block">
                        <input type="text" id="metaTitle" name="metaTitle" class="layui-input" placeholder="选填">
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="metaDescription">SEO 描述</label>
                    <div class="layui-input-block">
                        <textarea id="metaDescription" name="metaDescription" class="layui-textarea" placeholder="选填"></textarea>
                    </div>
                </div>
                <div class="layui-form-item">
                    <label class="layui-form-label" for="metaKeywords">SEO 关键词</label>
                    <div class="layui-input-block">
                        <input type="text" id="metaKeywords" name="metaKeywords" class="layui-input" placeholder="用逗号分隔多个关键词">
                    </div>
                </div>

                <!-- AI 生成元信息按钮 -->
                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button type="button" class="layui-btn layui-btn-normal" id="generateMeta">AI 生成 SEO</button>
                    </div>
                </div>

                <div class="layui-form-item">
                    <div class="layui-input-block">
                        <button type="submit" class="layui-btn" lay-submit>保存</button>
                        <a href="/admin/services" class="layui-btn layui-btn-primary" style="margin-left:10px;">返回</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<script type="module">
    import { AiEditor } from '/static/aieditor/index.js';

    // 登录检查
    const token = localStorage.getItem('jwt_token');
    if (!token) {
        window.location.href = '/admin/login';
    }

    let editor;
    let isEditMode = false;
    const form = document.getElementById('editForm');
    const pageTitle = document.getElementById('page-title');
    const serviceIdInput = document.getElementById('serviceId');

    function initAiEditor(initialHtml = '') {
        editor = new AiEditor({
            element: '#aiEditor',
            placeholder: '请输入正文内容',
            theme: 'light',
            content: initialHtml,
            contentIsMarkdown: false,
            contentRetention: false,
            onChange: (html) => {
                document.getElementById('content').value = html;
            },
            ai: {
                models: {
                    spark: {
                        appId: '',
                        apiKey: '',
                        apiSecret: '',
                    },
                },
            },
        });
    }

    function detectMode() {
        const parts = window.location.pathname.split('/');
        const idx = parts.indexOf('edit');
        if (idx >= 0 && parts.length > idx + 1) {
            const id = parts[idx + 1];
            if (!isNaN(id)) {
                isEditMode = true;
                serviceIdInput.value = id;
                pageTitle.textContent = `编辑服务 (ID: ${id})`;
                loadServiceData(id);
            }
        }
    }
    async function loadServiceData(id) {
        try {
            const resp = await fetch(`/api/v1/services/${id}`, {
                headers: { 'Authorization': `Bearer ${token}` },
            });
            if (!resp.ok) throw new Error('获取服务数据失败');
            const result = await resp.json();
            populateForm(result.data);
        } catch (e) {
            alert(e.message);
            window.location.href = '/admin/services';
        }
    }
    function populateForm(data) {
        document.getElementById('title').value = data.title;
        document.getElementById('summary').value = data.summary;
        document.getElementById('slug').value = data.slug;
        document.getElementById('sortOrder').value = data.sortOrder;
        document.getElementById('isRecommended').checked = data.isRecommended;
        document.getElementById('metaTitle').value = data.metaTitle || '';
        document.getElementById('metaDescription').value = data.metaDescription || '';
        document.getElementById('metaKeywords').value = data.metaKeywords || '';
        if (data.coverImageUrl) {
            document.getElementById('coverImageUrl').value = data.coverImageUrl;
            const preview = document.getElementById('coverPreview');
            preview.src = data.coverImageUrl;
            preview.style.display = 'block';
        }
        initAiEditor(data.content || '');
        document.getElementById('content').value = data.content;
    }
    // 封面图片上传
    const coverInput = document.getElementById('coverImage');
    coverInput.addEventListener('change', async function () {
        const file = this.files[0];
        if (!file) return;
        const fd = new FormData();
        fd.append('file', file);
        try {
            const resp = await fetch('/api/v1/upload', {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${token}` },
                body: fd,
            });
            const result = await resp.json();
            if (resp.ok) {
                document.getElementById('coverImageUrl').value = result.url;
                const preview = document.getElementById('coverPreview');
                preview.src = result.url;
                preview.style.display = 'block';
            } else {
                alert(result.error || '上传失败');
            }
        } catch (err) {
            alert('网络错误');
        }
    });
    form.addEventListener('submit', async function (e) {
        e.preventDefault();
        const html = typeof editor.getHtml === 'function' ? editor.getHtml() : document.getElementById('content').value;
        document.getElementById('content').value = html;
        const payload = {
            title: document.getElementById('title').value,
            summary: document.getElementById('summary').value,
            content: document.getElementById('content').value,
            slug: document.getElementById('slug').value,
            sortOrder: parseInt(document.getElementById('sortOrder').value) || 99,
            isRecommended: document.getElementById('isRecommended').checked,
            metaTitle: document.getElementById('metaTitle').value,
            metaDescription: document.getElementById('metaDescription').value,
            metaKeywords: document.getElementById('metaKeywords').value,
            coverImageUrl: document.getElementById('coverImageUrl').value,
        };
        let url = '/api/v1/services';
        let method = 'POST';
        if (isEditMode) {
            url = `/api/v1/services/${serviceIdInput.value}`;
            method = 'PUT';
        }
        try {
            const resp = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify(payload),
            });
            const result = await resp.json();
            if (resp.ok) {
                alert('保存成功！');
                window.location.href = '/admin/services';
            } else {
                alert(result.error || '保存失败');
            }
        } catch (err) {
            alert('网络错误');
        }
    });
    // AI 生成 SEO
    const generateMetaBtn = document.getElementById('generateMeta');
    generateMetaBtn.addEventListener('click', async function () {
        const titleVal = document.getElementById('title').value;
        const html = typeof editor.getHtml === 'function' ? editor.getHtml() : document.getElementById('content').value;
        try {
            const response = await fetch('/api/v1/ai/generate-meta', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`,
                },
                body: JSON.stringify({ title: titleVal, content: html }),
            });
            const result = await response.json();
            if (response.ok) {
                document.getElementById('metaTitle').value = result.metaTitle || '';
                document.getElementById('metaDescription').value = result.metaDescription || '';
                if (!document.getElementById('summary').value) {
                    document.getElementById('summary').value = result.metaDescription || '';
                }
                alert('AI 生成 SEO 信息成功');
            } else {
                alert(result.error || 'AI 生成失败');
            }
        } catch (error) {
            alert('网络错误');
        }
    });
    window.addEventListener('DOMContentLoaded', () => {
        initAiEditor('');
        detectMode();
    });
</script>
<!-- 引入 layui JS -->
<script src="https://cdn.staticfile.org/layui/2.8.0/layui.js"></script>
</body>
</html>